import json
import boto3
import urllib3
from base64 import b64encode

http = urllib3.PoolManager()

secrets = boto3.client("secretsmanager")
secret = json.loads(
    secrets.get_secret_value(SecretId="user")["SecretString"]
)

SNOW_INSTANCE = secret["SNOW_INSTANCE"]
SNOW_USER = secret["SNOW_USER"]
SNOW_PASSWORD = secret["SNOW_PASSWORD"]

AUTH = b64encode(f"{SNOW_USER}:{SNOW_PASSWORD}".encode()).decode()
HEADERS = {
    "Content-Type": "application/json",
    "Accept": "application/json",
    "Authorization": f"Basic {AUTH}"
}

NORMAL_CHANGE_MODEL_SYS_ID = "your_actual_sys_id_here"  # Replace with real sys_id

def handler(event, context):
    try:
        # Extract all AWS Health event details
        detail = event.get("detail", {})
        
        event_arn = detail.get("eventArn", "")
        event_type_code = detail.get("eventTypeCode", "")
        event_type_category = detail.get("eventTypeCategory", "")
        service = detail.get("service", "")
        region = detail.get("eventRegion", "")
        start_time = detail.get("startTime", "")
        end_time = detail.get("endTime", "")
        last_updated_time = detail.get("lastUpdatedTime", "")
        status_code = detail.get("statusCode", "")
        
        # Affected entities
        affected_entities = detail.get("affectedEntities", [])
        entity_values = [entity.get("entityValue", "") for entity in affected_entities]
        
        # Event description
        event_description = detail.get("eventDescription", [{}])[0].get("latestDescription", "No description available")
        
        # Build detailed description
        description = f"""AWS Health Event Details:

Event Type: {event_type_code}
Category: {event_type_category}
Service: {service}
Region: {region}
Status: {status_code}

Start Time: {start_time}
End Time: {end_time}
Last Updated: {last_updated_time}

Event ARN: {event_arn}

Affected Resources:
{chr(10).join(['- ' + entity for entity in entity_values]) if entity_values else 'None specified'}

Description:
{event_description}
"""
        
        # Determine priority based on category
        if event_type_category == "issue":
            priority = "2"  # High priority for issues
            impact = "2"
            urgency = "2"
        elif event_type_category == "scheduledChange":
            priority = "3"  # Medium priority for scheduled changes
            impact = "3"
            urgency = "3"
        else:
            priority = "4"  # Low priority for other events
            impact = "3"
            urgency = "3"
        
        # Short description with key details
        short_desc = f"AWS Health {event_type_category}: {event_type_code} - {service} in {region}"
        
        # 1. Create Case
        case_payload = {
            "short_description": short_desc[:160],  # ServiceNow field limit
            "description": description,
            "priority": priority,
            "correlation_id": event_arn,
            "contact_type": "monitoring",
            "state": "1"  # New/Open
        }
        
        print("Creating case...")
        case_response = http.request(
            'POST',
            f"{SNOW_INSTANCE}/api/now/table/sn_customerservice_case",
            headers=HEADERS,
            body=json.dumps(case_payload)
        )
        
        print(f"Case response status: {case_response.status}")
        case_data = json.loads(case_response.data.decode('utf-8'))
        
        if case_response.status != 201:
            return {
                "error": "Failed to create case",
                "status": case_response.status,
                "response": case_data
            }
        
        case_sys_id = case_data["result"]["sys_id"]
        case_number = case_data["result"]["number"]
        print(f"Case created: {case_number} ({case_sys_id})")
        
        # 2. Create Change
        change_payload = {
            "type": "normal",
            "short_description": short_desc[:160],
            "description": description,
            "correlation_id": event_arn,
            "justification": f"AWS Health event detected for {service} resources",
            "impact": impact,
            "urgency": urgency,
            "risk": "medium" if event_type_category == "issue" else "low",
            "category": "Cloud",
            "start_date": start_time if start_time else None,
            "end_date": end_time if end_time else None
        }
        
        # Only include chg_model if you have a valid sys_id
        if NORMAL_CHANGE_MODEL_SYS_ID and NORMAL_CHANGE_MODEL_SYS_ID != "your_actual_sys_id_here":
            change_payload["chg_model"] = NORMAL_CHANGE_MODEL_SYS_ID
        
        print("Creating change request...")
        chg_response = http.request(
            'POST',
            f"{SNOW_INSTANCE}/api/now/table/change_request",
            headers=HEADERS,
            body=json.dumps(change_payload)
        )
        
        print(f"Change response status: {chg_response.status}")
        chg_data = json.loads(chg_response.data.decode('utf-8'))
        
        if chg_response.status != 201:
            return {
                "error": "Failed to create change",
                "status": chg_response.status,
                "response": chg_data
            }
        
        change_sys_id = chg_data["result"]["sys_id"]
        change_number = chg_data["result"]["number"]
        print(f"Change created: {change_number} ({change_sys_id})")
        
        # 3. Link Case to Change (if your instance supports this field)
        # You may need to adjust the field name based on your ServiceNow configuration
        print("Linking case to change...")
        try:
            link_response = http.request(
                'PATCH',
                f"{SNOW_INSTANCE}/api/now/table/sn_customerservice_case/{case_sys_id}",
                headers=HEADERS,
                body=json.dumps({"watch_list": change_number})  # Or use appropriate linking field
            )
            print(f"Link response status: {link_response.status}")
        except Exception as link_error:
            print(f"Warning: Could not link case to change: {str(link_error)}")
        
        return {
            "status": "success",
            "case_number": case_number,
            "case_sys_id": case_sys_id,
            "change_number": change_number,
            "change_sys_id": change_sys_id,
            "event_arn": event_arn
        }
        
    except Exception as e:
        print(f"ERROR: {str(e)}")
        import traceback
        print(traceback.format_exc())
        return {
            "error": str(e),
            "traceback": traceback.format_exc()
        }
        
        case_sys_id = case_data["result"]["sys_id"]
        print(f"Case created: {case_sys_id}")
        
        # 2. Create Change
        change_payload = {
            "type": "normal",
            "chg_model": NORMAL_CHANGE_MODEL_SYS_ID,
            "risk": "medium",
            "short_description": "AWS Health EC2 Event",
            "description": "Automatically created from AWS Health",
            "correlation_id": event_arn
        }
        
        print("Creating change request...")
        chg_response = http.request(
            'POST',
            f"{SNOW_INSTANCE}/api/now/table/change_request",
            headers=HEADERS,
            body=json.dumps(change_payload)
        )
        
        print(f"Change response status: {chg_response.status}")
        print(f"Change response body: {chg_response.data.decode('utf-8')}")
        
        chg_data = json.loads(chg_response.data.decode('utf-8'))
        
        if chg_response.status != 201:
            return {
                "error": "Failed to create change",
                "status": chg_response.status,
                "response": chg_data
            }
        
        change_sys_id = chg_data["result"]["sys_id"]
        print(f"Change created: {change_sys_id}")
        
        # 3. Link Case â†’ Change (if your ServiceNow supports this relationship)
        print("Linking case to change...")
        link_response = http.request(
            'PATCH',
            f"{SNOW_INSTANCE}/api/now/table/sn_customerservice_case/{case_sys_id}",
            headers=HEADERS,
            body=json.dumps({"u_related_change": change_sys_id})  # Field name might differ
        )
        
        print(f"Link response status: {link_response.status}")
        
        return {
            "status": "ok",
            "case_sys_id": case_sys_id,
            "change_sys_id": change_sys_id
        }
        
    except Exception as e:
        print(f"ERROR: {str(e)}")
        import traceback
        print(traceback.format_exc())
        return {
            "error": str(e),
            "traceback": traceback.format_exc()
        }
