import json
import boto3
import urllib3
from base64 import b64encode

http = urllib3.PoolManager()

secrets = boto3.client("secretsmanager")
secret = json.loads(
    secrets.get_secret_value(SecretId="awshealthintegrationsuser")["SecretString"]
)

SNOW_INSTANCE = secret["SNOW_INSTANCE"]
SNOW_USER = secret["SNOW_USER"]
SNOW_PASSWORD = secret["SNOW_PASSWORD"]

AUTH = b64encode(f"{SNOW_USER}:{SNOW_PASSWORD}".encode()).decode()
HEADERS = {
    "Content-Type": "application/json",
    "Accept": "application/json",
    "Authorization": f"Basic {AUTH}"
}

def handler(event, context):
    # Step 1: Find case tables
    response = http.request(
        'GET',
        f"{SNOW_INSTANCE}/api/now/table/sys_db_object?sysparm_query=nameLIKEcase^ORlabelLIKEcase&sysparm_fields=name,label",
        headers=HEADERS
    )
   
    tables_data = json.loads(response.data.decode('utf-8'))
   
    # Step 2: Check user roles
    user_response = http.request(
        'GET',
        f"{SNOW_INSTANCE}/api/now/table/sys_user?sysparm_query=user_name={SNOW_USER}&sysparm_fields=sys_id",
        headers=HEADERS
    )
   
    user_data = json.loads(user_response.data.decode('utf-8'))
    user_sys_id = user_data['result'][0]['sys_id'] if user_data.get('result') else None
   
    roles = []
    if user_sys_id:
        roles_response = http.request(
            'GET',
            f"{SNOW_INSTANCE}/api/now/table/sys_user_has_role?sysparm_query=user={user_sys_id}&sysparm_fields=role.name",
            headers=HEADERS
        )
        roles_data = json.loads(roles_response.data.decode('utf-8'))
        roles = [r.get('role', {}).get('name') for r in roles_data.get('result', [])]
   
    # Step 3: Try creating a case
    case_payload = {"short_description": "Test"}
    case_response = http.request(
        'POST',
        f"{SNOW_INSTANCE}/api/now/table/sn_customerservice_case",
        headers=HEADERS,
        body=json.dumps(case_payload)
    )
   
    case_result = json.loads(case_response.data.decode('utf-8'))
   
    return {
        "case_tables": tables_data.get('result', []),
        "user_roles": roles,
        "case_creation_status": case_response.status,
        "case_creation_response": case_result
    }
